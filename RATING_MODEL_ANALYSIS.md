# –ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

## –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Keyword + Semantic)

–ú–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤–∞ —Å–ª–æ—è –¥–µ—Ç–µ–∫—Ü–∏–∏**:
- **Keyword Matching**: –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–ª–æ–≤ (–Ω–∞—Å–∏–ª–∏–µ, –º–∞—Ç, –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏ –∏ —Ç.–¥.)
- **Semantic Embeddings**: SentenceTransformer (all-MiniLM-L6-v2) –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω—ã

### 2. Workflow

```
–°—Ü–µ–Ω–∞—Ä–∏–π
  ‚Üì
–ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞ —Å—Ü–µ–Ω—ã (–ø–æ –º–∞—Ä–∫–µ—Ä–∞–º INT./EXT.)
  ‚Üì
–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã:
  1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (keyword matching)
     - violence_count, gore_count, sex_count, etc.
  2. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (semantic embeddings)
     - –°—Ö–æ–¥—Å—Ç–≤–æ —Å —à–∞–±–ª–æ–Ω–∞–º–∏: graphic_violence, stylized_action, discussion_violence, etc.
  3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ü–µ–Ω–æ–∫
     - Density-based: count / scene_length * 100
     - Multipliers based on context similarity
  ‚Üì
–ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é (max, p95, p90)
  ‚Üì
–ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥ (0+, 6+, 12+, 16+, 18+)
```

---

## üî¥ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥
r"\b—Ä–∞–Ω\w+"  # –õ–æ–≤–∏—Ç "—Ä–∞–Ω–∞" (wound) + "—Ä–∞–Ω—å—à–µ" (earlier) + "—Ä–∞–Ω–Ω–∏–π" (early)
r"\b–∫—Ä–æ–≤\w*" # –õ–æ–≤–∏—Ç "–∫—Ä–æ–≤—å" (blood) + "–∫—Ä–æ–≤–∞—Ç—å" (bed) + "–∫—Ä–æ–≤–∞" (shelter)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–µ—Ç—Å–∫–∏–π –ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–æ —Å–ª–æ–≤–æ–º "—Ä–∞–Ω—å—à–µ" –ø–æ–ª—É—á–∞–ª 100% gore ‚Üí 16+ —Ä–µ–π—Ç–∏–Ω–≥

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ù–æ–≤—ã–π –∫–æ–¥ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
r"\b—Ä–∞–Ω(?:–∞|—ã|—É|–æ–π|–µ|–∞–º|–∞–º–∏|–∞—Ö)\b"  # –¢–æ–ª—å–∫–æ —Ñ–æ—Ä–º—ã —Å–ª–æ–≤–∞ "—Ä–∞–Ω–∞"
r"\b–∫—Ä–æ–≤—å\b"                         # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
r"\b–∫—Ä–æ–≤–∞–≤\w*"                       # "–∫—Ä–æ–≤–∞–≤—ã–π" –±–µ–∑ "–∫—Ä–æ–≤–∞—Ç—å"

# + FALSE_POSITIVES —Ñ–∏–ª—å—Ç—Ä—ã
r"—Ä–∞–Ω(—å|–Ω)(—à–µ|–∏–π|—è—è|–µ–µ|–µ–≥–æ|–∏–º|–µ–º—É)" # –§–∏–ª—å—Ç—Ä—É–µ—Ç "—Ä–∞–Ω—å—à–µ", "—Ä–∞–Ω–Ω–∏–π"
```

---

### 2. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
gore_density = gore_count / max(1, L)
gore_raw = gore_density * 100  # 1 —Å–ª–æ–≤–æ –Ω–∞ 100 ‚Üí 1.0 (100%)!
```

–î–∞–∂–µ **1 –ª–æ–∂–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ** –≤ —Å—Ü–µ–Ω–µ –∏–∑ 100 —Å–ª–æ–≤ ‚Üí `gore_raw = 1.0` ‚Üí **100% gore**

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- –°–ª–∏—à–∫–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ –µ–¥–∏–Ω–∏—á–Ω—ã–º –ª–æ–∂–Ω—ã–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (1 —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ vs 5 —É–ø–æ–º–∏–Ω–∞–Ω–∏–π)

---

### 3. **Semantic embeddings –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥–∞—é—Ç**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ multipliers:**
```python
if ctx["discussion_violence"] > 0.55:
    violence_multiplier *= 0.3  # –°–Ω–∏–∂–∞–µ–º –Ω–∞ 70%
elif ctx["stylized_action"] > 0.5:
    violence_multiplier *= 0.6  # –°–Ω–∏–∂–∞–µ–º –Ω–∞ 40%
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–µ—Ç—Å–∫–∞—è –ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∞—è —Å—Ü–µ–Ω–∞ –º–æ–∂–µ—Ç **–Ω–µ** –Ω–∞–±—Ä–∞—Ç—å –≤—ã—Å–æ–∫–∏–π score –ø–æ "discussion_violence" –∏–ª–∏ "stylized_action"
- –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ multiplier –æ—Å—Ç–∞–µ—Ç—Å—è 1.0 –∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç
- all-MiniLM-L6-v2 –æ–±—É—á–µ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç–∞—Ö, –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö—É–∂–µ

---

### 4. **–ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è**

–ú–æ–¥–µ–ª—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç:
- **–î–∏–∞–ª–æ–≥** –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: "–Ø –Ω–∞—à–µ–ª —Ç—Ä—É–ø –≤ –ø–æ–¥–≤–∞–ª–µ" (DIALOGUE)
- **–î–µ–π—Å—Ç–≤–∏–µ**: "–ö—Ä–æ–≤—å –±—Ä—ã–∑–∂–µ—Ç –∏–∑ —Ä–∞–Ω—ã" (ACTION)

–ù–æ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ **–≤–∞–∂–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç**:
- –î–∏–∞–ª–æ–≥/–æ–±—Å—É–∂–¥–µ–Ω–∏–µ ‚Üí –º–µ–Ω–µ–µ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ
- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí –±–æ–ª–µ–µ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ

---

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

1. **FALSE_POSITIVES —Ñ–∏–ª—å—Ç—Ä—ã** - —É–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥, —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **Semantic similarity** - –∏–¥–µ—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è, –ø–æ–º–æ–≥–∞–µ—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
3. **–ì–∏–±—Ä–∏–¥–Ω—ã–π keyword + embedding** - —Ä–∞–∑—É–º–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
4. **Multilingual support** - —Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
5. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è–º** - —É–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (max, p95, p90)

---

## üöÄ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (–ë–ï–ó –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π)

### 1. **–£–ª—É—á—à–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é** (–õ–ï–ì–ö–û)

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å–µ–π—á–∞—Å:
```python
gore_raw = (gore_count / scene_length) * 100
# 1 —Å–ª–æ–≤–æ / 100 —Å–ª–æ–≤ = 0.01 * 100 = 1.0 (100%)
```

#### –ü—Ä–µ–¥–ª–∞–≥–∞—é:
```python
# –í–∞—Ä–∏–∞–Ω—Ç A: –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞
gore_raw = min(1.0, math.log(1 + gore_count) / math.log(1 + scene_length / 10))

# –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–π)
if gore_count == 0:
    gore_raw = 0.0
elif gore_count == 1:
    gore_raw = 0.2 if scene_length > 50 else 0.4  # –û–¥–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ - –Ω–∏–∑–∫–∏–π score
elif gore_count <= 3:
    gore_raw = 0.5  # –ù–µ—Å–∫–æ–ª—å–∫–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π - —Å—Ä–µ–¥–Ω–∏–π
else:
    gore_raw = min(1.0, gore_count / 5.0)  # –ú–Ω–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π - –≤—ã—Å–æ–∫–∏–π

# –í–∞—Ä–∏–∞–Ω—Ç C: TF-IDF –ø–æ–¥—Ö–æ–¥ (—É—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –≤ –∫–æ—Ä–ø—É—Å–µ)
idf = log(total_scenes / scenes_with_gore)
gore_raw = min(1.0, (gore_count / scene_length) * idf)
```

**–†–µ–∫–æ–º–µ–Ω–¥—É—é: –í–∞—Ä–∏–∞–Ω—Ç B** - –ø–æ–Ω—è—Ç–Ω—ã–π, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π, –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ—Ä–æ–≥–∏

---

### 2. **–£–ª—É—á—à–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã** (–°–†–ï–î–ù–ï)

–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è semantic matching:

```python
CONTEXT_TEMPLATES = {
    "children_adventure": [
        "–¥–µ—Ç–∏ –∏—â—É—Ç —Å–æ–∫—Ä–æ–≤–∏—â–∞ –∏ —Ä–µ—à–∞—é—Ç –∑–∞–≥–∞–¥–∫–∏",
        "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –¥–µ—Ç–µ–π –≤ –ø–æ–∏—Å–∫–∞—Ö –∫–ª–∞–¥–∞",
        "—Ä–µ–±—è—Ç–∞ –∏—Å—Å–ª–µ–¥—É—é—Ç —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ",
        "–¥—Ä—É–∂–±–∞ –¥–µ—Ç–µ–π –∏ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ",
    ],
    "family_friendly": [
        "–¥–æ–±—Ä–∞—è —Å–µ–º–µ–π–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è",
        "–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π —Ñ–∏–ª—å–º",
        "–∏—Å—Ç–æ—Ä–∏—è –æ –¥—Ä—É–∂–±–µ –∏ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏",
    ],
    # ... existing templates ...
}
```

–ó–∞—Ç–µ–º –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
```python
if ctx["children_adventure"] > 0.6 or ctx["family_friendly"] > 0.6:
    violence_multiplier *= 0.1  # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —Å–Ω–∏–∂–∞–µ–º
    gore_multiplier *= 0.1
```

---

### 3. **–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏—è** (–°–†–ï–î–ù–ï-–°–õ–û–ñ–ù–û)

–†–∞–∑–ª–∏—á–∞—Ç—å ACTION vs DIALOGUE:

```python
def extract_scene_type(scene_text: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Å—Ü–µ–Ω–µ.

    ACTION: –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    DIALOGUE: —Ä–µ—á—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    DESCRIPTION: –æ–ø–∏—Å–∞–Ω–∏—è –ª–æ–∫–∞—Ü–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    """
    # –ü—Ä–æ—Å—Ç–æ–π —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥
    lines = scene_text.split('\n')

    dialogue_lines = 0
    action_lines = 0

    for line in lines:
        line = line.strip()

        # –î–∏–∞–ª–æ–≥ - —Å—Ç—Ä–æ–∫–∏ —Å –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (–ó–ê–ì–õ–ê–í–ù–´–ï) –∏–ª–∏ –≤ —Å–∫–æ–±–∫–∞—Ö
        if re.match(r'^[–ê-–ØA-Z\s]+$', line) and len(line) < 50:
            # –≠—Ç–æ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            dialogue_lines += 1
        elif line.startswith('(') and line.endswith(')'):
            # –†–µ–º–∞—Ä–∫–∞
            continue
        elif len(line) > 0 and not line.isupper():
            # –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ
            # –î–∏–∞–ª–æ–≥ –æ–±—ã—á–Ω–æ –∫–æ—Ä–æ—á–µ, –¥–µ–π—Å—Ç–≤–∏–µ - –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω–µ–µ
            if len(line) < 60:
                dialogue_lines += 1
            else:
                action_lines += 1

    if dialogue_lines > action_lines * 2:
        return "dialogue"  # –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–∏–∞–ª–æ–≥
    else:
        return "action"    # –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ

# –í –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
scene_type = extract_scene_type(scene_text)
if scene_type == "dialogue":
    violence_multiplier *= 0.5  # –û–±—Å—É–∂–¥–µ–Ω–∏–µ –º–µ–Ω–µ–µ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ
    gore_multiplier *= 0.5
```

---

### 4. **–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏** (–õ–ï–ì–ö–û)

–£—á–∏—Ç—ã–≤–∞—Ç—å, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å–ª–æ–≤–æ:

```python
def analyze_keyword_context(keyword, text):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞.

    –ü—Ä–∏–º–µ—Ä—ã:
    - "–≥–æ–≤–æ—Ä–∏–ª–∏ –æ –∫—Ä–æ–≤–∏" ‚Üí discussion, —Å–Ω–∏–∂–∞–µ–º weight
    - "–∫—Ä–æ–≤—å –±—Ä—ã–∑–Ω—É–ª–∞" ‚Üí action, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º weight
    """
    # –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞
    discussion_markers = [
        r"–≥–æ–≤–æ—Ä\w+\s+–æ",
        r"—Ä–∞—Å—Å–∫–∞–∑\w+\s+–æ",
        r"—É–ø–æ–º–∏–Ω\w+",
        r"—Å–ª—ã—à\w+\s+–æ",
        r"–µ—Å–ª–∏.*—Ç–æ",  # hypothetical
    ]

    action_markers = [
        r"–±—Ä—ã–∑–Ω\w+",
        r"—Ç–µ–∫(–ª–∞|–ª–æ|–ª–∏)",
        r"–ª–∏–ª\w+",
        r"–≤–∏–¥–µ–ª\w*",
    ]

    excerpt = get_excerpt_around_keyword(keyword, text)

    for pattern in discussion_markers:
        if re.search(pattern, excerpt, re.I):
            return 0.3  # discussion weight

    for pattern in action_markers:
        if re.search(pattern, excerpt, re.I):
            return 1.5  # action weight

    return 1.0  # neutral
```

---

### 5. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∂–∞–Ω—Ä–∞** (–õ–ï–ì–ö–û)

–ï—Å–ª–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è —É–∫–∞–∑–∞–Ω –∂–∞–Ω—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ:

```python
def extract_genre(script_text: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∂–∞–Ω—Ä –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è."""
    # –ò—â–µ–º –≤ –ø–µ—Ä–≤—ã—Ö 500 —Å–∏–º–≤–æ–ª–∞—Ö
    header = script_text[:500]

    genre_patterns = {
        "family": r"(—Å–µ–º–µ–π–Ω—ã–π|–¥–µ—Ç—Å–∫–∏–π|–¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏|family|kids)",
        "adventure": r"(–ø—Ä–∏–∫–ª—é—á–µ–Ω\w+|adventure)",
        "horror": r"(—É–∂–∞—Å—ã|—Ö–æ—Ä—Ä–æ—Ä|horror)",
        "action": r"(–±–æ–µ–≤–∏–∫|—ç–∫—à–Ω|action)",
        "drama": r"(–¥—Ä–∞–º–∞|drama)",
    }

    for genre, pattern in genre_patterns.items():
        if re.search(pattern, header, re.I):
            return genre

    return "unknown"

# –í –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
genre = extract_genre(full_script_text)
if genre == "family":
    violence_multiplier *= 0.2
    gore_multiplier *= 0.2
elif genre == "horror":
    # –ù–µ –ø–æ–≤—ã—à–∞–µ–º - —É–∂–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–∂–µ –æ—Ü–µ–Ω–µ–Ω—ã
    pass
```

---

### 6. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø–æ—Ä–æ–≥–∏** (–õ–ï–ì–ö–û)

–í–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å:

```python
def map_scores_to_rating_v2(agg: Dict[str, Any]) -> Dict[str, Any]:
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å —É—á–µ—Ç–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.
    """
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º "–ø—Ä–æ–±–ª–µ–º–Ω–æ—Å—Ç—å"
    problem_score = (
        agg["violence"] * 2.0 +
        agg["gore"] * 2.5 +
        agg["sex_act"] * 3.0 +
        agg["profanity"] * 1.0 +
        agg["drugs"] * 1.5 +
        agg["child_risk"] * 4.0  # –î–µ—Ç–∏ –≤ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
    )

    # –ü–æ—Ä–æ–≥–∏ —Å –∑–æ–Ω–∞–º–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏
    if problem_score < 0.5:
        rating = "0+"
    elif problem_score < 1.0:
        rating = "6+"
    elif problem_score < 2.5:
        rating = "12+"
    elif problem_score < 5.0:
        rating = "16+"
    else:
        rating = "18+"

    # –û—Ç–¥–µ–ª—å–Ω—ã–µ "–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏" - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—ã—à–∞—é—Ç —Ä–µ–π—Ç–∏–Ω–≥
    if agg["sex_act"] > 0.7 or agg["child_risk"] > 0.8:
        rating = "18+"
    elif agg["gore"] > 0.8:
        rating = max(rating, "16+")

    return {"rating": rating, ...}
```

---

### 7. **–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É** (–°–†–ï–î–ù–ï)

–°–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ñ–∏–ª—å–º–∞–º –∏ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –ø–æ—Ä–æ–≥–∏:

```python
# –ü—Ä–∏–º–µ—Ä: —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
calibration_data = [
    {"film": "–¢–∞–π–Ω–∞ —Å—Ç–∞—Ä–æ–≥–æ –º–∞—è–∫–∞", "expected_rating": "6+", "features": {...}},
    {"film": "–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä", "expected_rating": "16+", "features": {...}},
    # ... –µ—â–µ 50-100 –ø—Ä–∏–º–µ—Ä–æ–≤
]

# –ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ —á–µ—Ä–µ–∑ grid search
def calibrate_thresholds(calibration_data):
    best_accuracy = 0
    best_thresholds = None

    for violence_threshold in np.arange(0.3, 0.8, 0.05):
        for gore_threshold in np.arange(0.4, 0.9, 0.05):
            # ... —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            accuracy = evaluate(calibration_data, thresholds)
            if accuracy > best_accuracy:
                best_accuracy = accuracy
                best_thresholds = thresholds

    return best_thresholds
```

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π

| –£–ª—É—á—à–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –≠—Ñ—Ñ–µ–∫—Ç | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-----------|-----------|--------|-----------|
| 1. –§–∏–∫—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–í–∞—Ä–∏–∞–Ω—Ç B) | üü¢ –õ–µ–≥–∫–æ | üî•üî•üî• –í—ã—Å–æ–∫–∏–π | **1** |
| 2. –î–æ–±–∞–≤–∏—Ç—å children_adventure —à–∞–±–ª–æ–Ω—ã | üü¢ –õ–µ–≥–∫–æ | üî•üî• –°—Ä–µ–¥–Ω–∏–π | **2** |
| 3. –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–ª–æ–≤–∞ | üü° –°—Ä–µ–¥–Ω–µ | üî•üî• –°—Ä–µ–¥–Ω–∏–π | **3** |
| 4. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ACTION/DIALOGUE | üü° –°—Ä–µ–¥–Ω–µ | üî•üî•üî• –í—ã—Å–æ–∫–∏–π | **4** |
| 5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∂–∞–Ω—Ä–∞ | üü¢ –õ–µ–≥–∫–æ | üî• –ù–∏–∑–∫–∏–π | **5** |
| 6. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø–æ—Ä–æ–≥–∏ | üü¢ –õ–µ–≥–∫–æ | üî• –ù–∏–∑–∫–∏–π | **6** |
| 7. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ | üî¥ –°–ª–æ–∂–Ω–æ | üî•üî•üî• –í—ã—Å–æ–∫–∏–π | **7** |

---

## üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã (–±–µ–∑ BERT)

### A. Zero-shot classification —á–µ—Ä–µ–∑ embeddings
```python
from sentence_transformers import SentenceTransformer, util

# –í–º–µ—Å—Ç–æ —à–∞–±–ª–æ–Ω–æ–≤ - –ø—Ä—è–º–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
labels = ["family-friendly", "violent", "sexual", "horror"]
label_embeddings = model.encode(labels)

scene_embedding = model.encode(scene_text)
similarities = util.cos_sim(scene_embedding, label_embeddings)

# –ï—Å–ª–∏ "family-friendly" score > 0.7 ‚Üí —Å–Ω–∏–∂–∞–µ–º –≤—Å–µ –≤–µ—Å–∞
if similarities[0][0] > 0.7:  # family-friendly
    violence_multiplier *= 0.1
```

### B. Rule-based NER –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
```python
# –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
characters = extract_character_names(script)

# –ï—Å–ª–∏ –≤ —Å—Ü–µ–Ω–µ –¥–µ—Ç–∏ + –Ω–∞—Å–∏–ª–∏–µ ‚Üí child_risk
for char in scene_characters:
    if is_child(char) and violence_count > 0:
        child_risk = 1.0
```

### C. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ (—á–∞—Å—Ç–æ—Ç–∞ —Å–ª–æ–≤)
```python
from sklearn.feature_extraction.text import TfidfVectorizer

# –û–±—É—á–∞–µ–º –Ω–∞ –∫–æ—Ä–ø—É—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
vectorizer = TfidfVectorizer(max_features=1000)
X = vectorizer.fit_transform(known_scripts)

# TF-IDF –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∑–≤–µ—à–∏–≤–∞–µ—Ç —Ä–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞ –≤—ã—à–µ
scene_vector = vectorizer.transform([scene_text])
```

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: Quick wins (1-2 –¥–Ω—è)
1. ‚úÖ –§–∏–∫—Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
2. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é (–í–∞—Ä–∏–∞–Ω—Ç B —Å –ø–æ—Ä–æ–≥–∞–º–∏)
3. –î–æ–±–∞–≤–∏—Ç—å 10-15 —Ä—É—Å—Å–∫–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è semantic matching

### –§–∞–∑–∞ 2: –°—Ä–µ–¥–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (3-5 –¥–Ω–µ–π)
4. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ACTION/DIALOGUE
5. –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–ª–æ–≤–∞
6. –°–æ–±—Ä–∞—Ç—å 20-30 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –§–∞–∑–∞ 3: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (1-2 –Ω–µ–¥–µ–ª–∏)
7. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞ –±–æ–ª—å—à–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ
8. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
9. Continuous improvement loop

---

## üìä –û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏

### –ü–ª—é—Å—ã:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ GPU
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è (< 1 —Å–µ–∫ –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π)
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è –∏ –æ—Ç–ª–∞–∂–∏–≤–∞–µ–º–∞—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ + –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
- ‚úÖ –£–º–Ω—ã–π –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

### –ú–∏–Ω—É—Å—ã:
- ‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π (–¥–æ —Ñ–∏–∫—Å–∞)
- ‚ùå –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞
- ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ü–µ–Ω–∞—Ä–∏—è
- ‚ùå Semantic embeddings —Å–ª–∞–±–æ –ø–æ–º–æ–≥–∞—é—Ç –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ

### –û—Ü–µ–Ω–∫–∞: **7/10**
- –•–æ—Ä–æ—à–∞—è –æ—Å–Ω–æ–≤–∞
- –ù—É–∂–Ω—ã —Ç–æ—á–µ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- –ë–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å 9/10

---

## üé¨ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å - **solid baseline** —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** - —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ (‚úÖ **–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**)
2. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** - —Å–ª–∏—à–∫–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è (üîß **—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏**)
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - semantic –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (üîß **–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å**)

**–ë–µ–∑ BERT** –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å –æ—Ç–ª–∏—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è:
- –õ—É—á—à–∏–µ —Ä–µ–≥—É–ª—è—Ä–∫–∏ + —Ñ–∏–ª—å—Ç—Ä—ã
- –ë–æ–ª–µ–µ —É–º–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é
- –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è (ACTION vs DIALOGUE)
- –ë–æ–ª—å—à–µ semantic —à–∞–±–ª–æ–Ω–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É

–ö–æ–¥ —á–∏—Å—Ç—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π. –†–µ–∫–æ–º–µ–Ω–¥—É—é –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ –§–∞–∑–∞–º 1-2-3 –≤—ã—à–µ.
